<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Signal Map - ì‹¤ì‹œê°„ ì‹ í˜¸ë“± ì§€ë„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=33ea8f4ecaedf7e2a2ef457211594d5"></script>
    
    <style>
        :root { --bg: #0f1113; --red: #ff3b3b; --green: #00ff90; --card: #1c1e21; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; font-family: "Pretendard", sans-serif; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; }

        /* í•˜ë‹¨ ìƒì„¸ ì •ë³´ ì‹œíŠ¸ */
        #detailSheet {
            position: fixed; bottom: -100%; left: 0; right: 0;
            background: var(--card); z-index: 100;
            border-radius: 30px 30px 0 0; padding: 30px 20px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
            transition: bottom 0.4s ease-out; text-align: center;
        }
        #detailSheet.active { bottom: 0; }
        #timer { font-size: 70px; font-weight: 800; margin: 10px 0; }
        
        .lamp-box { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
        .lamp { width: 15px; height: 15px; border-radius: 50%; background: #333; }
        .lamp.red.on { background: var(--red); box-shadow: 0 0 15px var(--red); }
        .lamp.green.on { background: var(--green); box-shadow: 0 0 15px var(--green); }

        .sync-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .sync-btn { 
            background: #2a2d2f; border: 1px solid #3a3d40; padding: 18px; 
            color: #efefef; border-radius: 16px; font-size: 14px; font-weight: 700; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div id="detailSheet">
        <div style="color:#888; font-size:14px;">ì„œìš¸ ì‹œì²­ êµì°¨ë¡œ</div>
        <div id="timer">--</div>
        <div class="lamp-box">
            <div id="l-red" class="lamp red"></div>
            <div id="l-green" class="lamp green"></div>
        </div>
        <div class="sync-grid">
            <button class="sync-btn" onclick="sync(0)">ğŸ”´ R1 ì‹œì‘</button>
            <button class="sync-btn" onclick="sync(1)">ğŸŸ¢ G1 ì‹œì‘</button>
            <button class="sync-btn" onclick="sync(2)">ğŸ”´ R2 ì‹œì‘</button>
            <button class="sync-btn" onclick="sync(3)">ğŸŸ¢ G2 ì‹œì‘</button>
        </div>
        <button onclick="document.getElementById('detailSheet').classList.remove('active')" style="margin-top:20px; background:none; border:none; color:#555;">ë‹«ê¸°</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxwM-IBryLUHgCkOCFphd2GVhqILAINAk",
        authDomain: "signal-902a9.firebaseapp.com",
        databaseURL: "https://signal-902a9-default-rtdb.firebaseio.com",
        projectId: "signal-902a9",
        storageBucket: "signal-902a9.firebasestorage.app",
        messagingSenderId: "1040774154277",
        appId: "1:1040774154277:web:21c0ca2b2b2e9f6dca17cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const PATTERN = [110, 26.5, 35.5, 26.5];
    const TOTAL = PATTERN.reduce((a, b) => a + b, 0);
    let startTime = null;

    // ì¹´ì¹´ì˜¤ ì§€ë„ ì´ˆê¸°í™”
    const map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(37.5668, 126.9786),
        level: 3
    });

    const marker = new kakao.maps.Marker({ position: map.getCenter(), map: map });
    kakao.maps.event.addListener(marker, 'click', () => {
        document.getElementById('detailSheet').classList.add('active');
    });

    // ë™ê¸°í™” í•¨ìˆ˜ (ì „ì—­ window ê°ì²´ì— ë“±ë¡í•˜ì—¬ ì—ëŸ¬ ë°©ì§€)
    window.sync = (index) => {
        let offset = 0;
        for(let i=0; i<index; i++) offset += PATTERN[i];
        set(ref(db, "signal/start"), (Date.now() / 1000) - offset);
    };

    onValue(ref(db, "signal/start"), snap => {
        startTime = snap.val();
    });

    function update() {
        if(startTime) {
            const now = Date.now() / 1000;
            let cycle = (now - startTime) % TOTAL;
            let acc = 0;
            for(let i=0; i<PATTERN.length; i++) {
                if(cycle < acc + PATTERN[i]) {
                    const rem = Math.ceil(acc + PATTERN[i] - cycle);
                    const isRed = (i === 0 || i === 2);
                    document.getElementById('l-red').classList.toggle('on', isRed);
                    document.getElementById('l-green').classList.toggle('on', !isRed);
                    const t = document.getElementById('timer');
                    t.innerText = rem;
                    t.style.color = isRed ? "var(--red)" : "var(--green)";
                    break;
                }
                acc += PATTERN[i];
            }
        }
        requestAnimationFrame(update);
    }
    update();
</script>
</body>
</html>
