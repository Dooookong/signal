<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì‹ í˜¸ë“±</title>

<style>
body {
  font-family: sans-serif;
  text-align: center;
  background: #111;
  color: white;
}

#clock {
  font-size: 22px;
  margin: 20px;
}

.signal {
  width: 140px;
  margin: 20px auto;
  padding: 20px;
  background: #222;
  border-radius: 25px;
}

.light {
  width: 80px;
  height: 80px;
  margin: 15px auto;
  border-radius: 50%;
  background: #333;
  transition: 0.3s;
  box-shadow: inset 0 0 10px black;
}

.red.active {
  background: red;
  box-shadow: 0 0 35px red;
}

.green.active {
  background: lime;
  box-shadow: 0 0 35px lime;
}

#status {
  font-size: 26px;
  margin-top: 15px;
}

/* ğŸ”¥ í•µì‹¬: ì‹ í˜¸ë“± ìˆ«ì ìŠ¤íƒ€ì¼ */
#timer {
  font-size: 72px;
  font-weight: bold;
  margin: 10px;
  color: #ff3b3b;
  text-shadow: 0 0 20px red;
}

.green-mode {
  color: #00ff90 !important;
  text-shadow: 0 0 20px lime !important;
}

button {
  padding: 10px 20px;
  margin: 10px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  cursor: pointer;
}

.admin-panel {
  margin-top: 30px;
  padding: 15px;
  background: #222;
  border-radius: 15px;
  display: none;
}

input {
  padding: 8px;
  margin: 5px;
  width: 80px;
  text-align: center;
}
</style>
</head>

<body>

<div id="clock">ë™ê¸°í™” ì¤‘...</div>

<div class="signal">
  <div id="redLight" class="light red"></div>
  <div id="greenLight" class="light green"></div>
</div>

<div id="status">ëŒ€ê¸°ì¤‘</div>
<div id="timer">--</div>

<button id="startBtn">ğŸš¦ ì‹ í˜¸ ì‹œì‘</button>
<button id="adminBtn">ğŸ” ê´€ë¦¬ì</button>

<div class="admin-panel" id="adminPanel">

  <h3>ê´€ë¦¬ì ì„¤ì •</h3>

  ğŸ”´ ë¹¨ê°„ë¶ˆ(1) <input id="red1" value="60"> ì´ˆ<br>
  ğŸŸ¢ ì´ˆë¡ë¶ˆ(1) <input id="green1" value="30"> ì´ˆ<br>
  ğŸ”´ ë¹¨ê°„ë¶ˆ(2) <input id="red2" value="20"> ì´ˆ<br>
  ğŸŸ¢ ì´ˆë¡ë¶ˆ(2) <input id="green2" value="30"> ì´ˆ<br>

  <button id="applyBtn">ì ìš©</button>
  <button id="resetBtn">ë¦¬ì…‹</button>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAxwM-IBryLUHgCkOCFphd2GVhqILAINAk",
  authDomain: "signal-902a9.firebaseapp.com",
  databaseURL: "https://signal-902a9-default-rtdb.firebaseio.com",
  projectId: "signal-902a9",
  storageBucket: "signal-902a9.firebasestorage.app",
  messagingSenderId: "1040774154277",
  appId: "1:1040774154277:web:21c0ca2b2b2e9f6dca17cc"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const offsetRef = ref(db, ".info/serverTimeOffset");
let serverOffset = 0;

onValue(offsetRef, snap => serverOffset = snap.val());

function getServerTime() {
  return Date.now() + serverOffset;
}

const startRef = ref(db, "signal/startTime");
const patternRef = ref(db, "signal/pattern");

let pattern = [
  { color: "red", duration: 60 },
  { color: "green", duration: 30 },
  { color: "red", duration: 20 },
  { color: "green", duration: 30 }
];

/* ğŸ”¥ ê´€ë¦¬ì ìˆ˜ì • ì ìš© ë¬¸ì œ í•´ê²° */
onValue(patternRef, snap => {
  if (snap.exists()) {
    pattern = snap.val());   // ğŸ‘ˆ í•µì‹¬ ìˆ˜ì •
  }
});

startBtn.onclick = () => set(startRef, getServerTime());

adminBtn.onclick = () => {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸");
  if (pw === "1234") adminPanel.style.display = "block";
};

applyBtn.onclick = () => {

  const newPattern = [
    { color: "red", duration: Number(red1.value) },
    { color: "green", duration: Number(green1.value) },
    { color: "red", duration: Number(red2.value) },
    { color: "green", duration: Number(green2.value) }
  ];

  set(patternRef, newPattern);
};

resetBtn.onclick = () => set(startRef, getServerTime());

onValue(startRef, snap => {
  const startTime = Number(snap.val());
  if (!startTime || isNaN(startTime)) return;


  function update() {

    const now = getServerTime();
    const elapsed = Math.floor((now - startTime) / 1000);

    const total = pattern.reduce((s,p)=>s+p.duration,0);
    const pos = elapsed % total;

    let acc = 0;
    let current;

    for (const p of pattern) {
      if (pos < acc + p.duration) {
        current = {
          color: p.color,
          remaining: acc + p.duration - pos
        };
        break;
      }
      acc += p.duration;
    }

    redLight.classList.remove("active");
    greenLight.classList.remove("active");
    timer.classList.remove("green-mode");

    if (current.color === "red") {
      redLight.classList.add("active");
      status.innerText = "ğŸ”´ ë¹¨ê°„ë¶ˆ";
    } else {
      greenLight.classList.add("active");
      status.innerText = "ğŸŸ¢ ì´ˆë¡ë¶ˆ";
      timer.classList.add("green-mode");
    }

    timer.innerText = current.remaining;

    requestAnimationFrame(update);
  }

  update();
});

/* ì„œë²„ ì‹œê³„ */
function updateClock() {
  const now = new Date(getServerTime());
  const kr = new Date(now.toLocaleString("en-US",{timeZone:"Asia/Seoul"}));
  clock.innerText = `KR í˜„ì¬ ì‹œê°: ${kr.toLocaleTimeString()}`;
  requestAnimationFrame(updateClock);
}

updateClock();
</script>

</body>
</html>


