<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ìš°ë¦¬ì§‘ ì‹ í˜¸ë“±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { text-align:center; font-family:Arial; margin-top:30px; }
.clock { font-size:22px; margin-bottom:20px; }
.state { font-size:40px; margin-top:30px; }
.count { font-size:70px; }
button { font-size:20px; padding:10px 20px; margin:10px; }
</style>
</head>

<body>

<div class="clock" id="clock"></div>
<div class="state" id="state"></div>
<div class="count" id="time"></div>

<button onclick="setStart()">ðŸš¦ ì§€ê¸ˆ ì‹ í˜¸ ì‹œìž‘</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAxwM-IBryLUHgCkOCFphd2GVhqILAINAk",
  authDomain: "signal-902a9.firebaseapp.com",
  databaseURL: "https://signal-902a9-default-rtdb.firebaseio.com",
  projectId: "signal-902a9",
  storageBucket: "signal-902a9.firebasestorage.app",
  messagingSenderId: "1040774154277",
  appId: "1:1040774154277:web:21c0ca2b2b2e9f6dca17cc"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const PATTERN = [
    { state: "RED", duration: 60 },
    { state: "GREEN", duration: 30 },
    { state: "RED", duration: 20 },
    { state: "GREEN", duration: 30 }
];

const TOTAL = PATTERN.reduce((sum, p) => sum + p.duration, 0);

let startTime = null;

function updateClock() {
    const now = new Date();
    const seoulTime = now.toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
    });

    document.getElementById("clock").innerText =
        "ðŸ‡°ðŸ‡· í˜„ìž¬ ì‹œê° (ì„œìš¸): " + seoulTime;
}

window.setStart = function() {
    set(ref(db, "signal/start"), Math.floor(Date.now() / 1000));
};

onValue(ref(db, "signal/start"), snapshot => {
    startTime = snapshot.val();
});

function updateSignal() {

    if (!startTime) return;

    const now = Math.floor(Date.now() / 1000);
    let cycle = (now - startTime) % TOTAL;

    let accumulated = 0;

    for (let step of PATTERN) {

        if (cycle < accumulated + step.duration) {

            const remaining = accumulated + step.duration - cycle;

            document.getElementById("state").innerText =
                step.state === "GREEN" ? "ðŸŸ¢ ì´ˆë¡ë¶ˆ" : "ðŸ”´ ë¹¨ê°„ë¶ˆ";

            document.getElementById("time").innerText =
                remaining + "ì´ˆ";

            break;
        }

        accumulated += step.duration;
    }
}

function updateAll() {
    updateClock();
    updateSignal();
}

setInterval(updateAll, 1000);

</script>

</body>
</html>
