<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAxwM-IBryLUHgCkOCFphd2GVhqILAINAk",
  authDomain: "signal-902a9.firebaseapp.com",
  databaseURL: "https://signal-902a9-default-rtdb.firebaseio.com",
  projectId: "signal-902a9",
  storageBucket: "signal-902a9.firebasestorage.app",
  messagingSenderId: "1040774154277",
  appId: "1:1040774154277:web:21c0ca2b2b2e9f6dca17cc"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const offsetRef = ref(db, ".info/serverTimeOffset");
let serverOffset = 0;

onValue(offsetRef, snap => serverOffset = snap.val());

function getServerTime() {
  return Date.now() + serverOffset;
}

const startRef = ref(db, "signal/startTime");
const patternRef = ref(db, "signal/pattern");

let pattern = [
  { color: "red", duration: 60 },
  { color: "green", duration: 30 },
  { color: "red", duration: 20 },
  { color: "green", duration: 30 }
];

// ê´„í˜¸ ì˜¤íƒ€ ìˆ˜ì • ì™„ë£Œ
onValue(patternRef, snap => {
  if (snap.exists()) {
    pattern = snap.val(); 
  }
});

// ë²„íŠ¼ ì—˜ë¦¬ë¨¼íŠ¸ ì°¸ì¡° (ì¼ë¶€ ë¸Œë¼ìš°ì € ëŒ€ì‘)
const startBtn = document.getElementById('startBtn');
const adminBtn = document.getElementById('adminBtn');
const applyBtn = document.getElementById('applyBtn');
const resetBtn = document.getElementById('resetBtn');
const adminPanel = document.getElementById('adminPanel');
const redLight = document.getElementById('redLight');
const greenLight = document.getElementById('greenLight');
const status = document.getElementById('status');
const timer = document.getElementById('timer');
const clock = document.getElementById('clock');

// ìž…ë ¥ì°½ë“¤ë„ ì°¸ì¡°í•´ì•¼ ê´€ë¦¬ìž ì„¤ì •ì´ ìž‘ë™í•©ë‹ˆë‹¤.
const red1 = document.getElementById('red1');
const green1 = document.getElementById('green1');
const red2 = document.getElementById('red2');
const green2 = document.getElementById('green2');

startBtn.onclick = () => set(startRef, getServerTime());

adminBtn.onclick = () => {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸");
  if (pw === "1234") adminPanel.style.display = "block";
};

applyBtn.onclick = () => {
  const newPattern = [
    { color: "red", duration: Number(document.getElementById('red1').value) },
    { color: "green", duration: Number(document.getElementById('green1').value) },
    { color: "red", duration: Number(document.getElementById('red2').value) },
    { color: "green", duration: Number(document.getElementById('green2').value) }
  ];
  set(patternRef, newPattern);
};

resetBtn.onclick = () => set(startRef, getServerTime());

onValue(startRef, snap => {
  const startTime = Number(snap.val());
  if (!startTime || isNaN(startTime)) return;

  function update() {
    const now = getServerTime();
    const elapsed = Math.floor((now - startTime) / 1000);

    const total = pattern.reduce((s,p)=>s+p.duration,0);
    const pos = elapsed % total;

    let acc = 0;
    let current = { color: "red", remaining: 0 };

    for (const p of pattern) {
      if (pos < acc + p.duration) {
        current = {
          color: p.color,
          remaining: acc + p.duration - pos
        };
        break;
      }
      acc += p.duration;
    }

    redLight.classList.remove("active");
    greenLight.classList.remove("active");
    timer.classList.remove("green-mode");

    if (current.color === "red") {
      redLight.classList.add("active");
      status.innerText = "ðŸ”´ ë¹¨ê°„ë¶ˆ";
    } else {
      greenLight.classList.add("active");
      status.innerText = "ðŸŸ¢ ì´ˆë¡ë¶ˆ";
      timer.classList.add("green-mode");
    }

    timer.innerText = current.remaining;
    requestAnimationFrame(update);
  }
  update();
});

function updateClock() {
  const now = new Date(getServerTime());
  clock.innerText = `KR í˜„ìž¬ ì‹œê°: ${now.toLocaleTimeString('ko-KR', {timeZone:'Asia/Seoul'})}`;
  requestAnimationFrame(updateClock);
}
updateClock();
</script>
