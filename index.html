<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>신호등</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --bg: #0b0c0e;
            --signal-body: #1a1a1a;
            --red: #ff4d4d;
            --green: #00e676;
            --off: #2c2c2c;
            --text-main: #ececec;
            --accent: #ffffff;
        }

        body { 
            background-color: var(--bg); color: var(--text-main); text-align: center; 
            font-family: "Pretendard", sans-serif; margin: 0; padding: 30px 20px;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh;
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }

        #top-bar { margin-bottom: 20px; border-bottom: 1px solid #222; padding-bottom: 15px; width: 200px; }
        .date-display { font-size: 14px; color: #666; display: block; letter-spacing: 1px; }
        .time-display { font-size: 22px; font-weight: 700; display: block; margin-top: 5px; font-variant-numeric: tabular-nums; }

        /* 버전 선택 탭 */
        .version-selector { display: flex; gap: 8px; margin-bottom: 15px; width: 100%; max-width: 340px; }
        .version-btn.active { 
            background: #ffffff; /* 순백색 배경 */
            color: #000000;    /* 검정색 글자 */
            border-color: #ffffff; 
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3); /* 은은한 광택 효과 */
        }
        .version-btn { 
            flex: 1; padding: 10px; border-radius: 12px; border: 1px solid #333; 
            background: #ffffff; color: #000000; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s;
        }
        .version-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        

        /* 신호등 본체 */
        .pedestrian-signal {
            width: 140px; background: var(--signal-body); padding: 25px; border-radius: 35px;
            box-shadow: 0 40px 80px rgba(0,0,0,0.6), inset 0 0 3px rgba(255,255,255,0.05);
            border: 4px solid #222; margin-bottom: 30px;
        }

        .lamp-section {
            width: 120px; height: 120px; background: #000; border-radius: 20px;
            margin: 15px auto; display: flex; align-items: center; justify-content: center;
            border: 2px solid #1a1a1a; box-shadow: inset 0 5px 20px rgba(0,0,0,0.9);
            position: relative;
        }

        .walker-svg { width: 85px; height: 85px; fill: var(--off); transition: all 0.3s ease; }
        .red-active .walker-svg.stop { fill: var(--red); filter: drop-shadow(0 0 12px rgba(255, 77, 77, 0.8)); }
        .green-active .walker-svg.walk { fill: var(--green); filter: drop-shadow(0 0 12px rgba(0, 230, 118, 0.8)); }

        @keyframes blink {
            0%, 100% { opacity: 1; filter: drop-shadow(0 0 12px rgba(0, 230, 118, 0.8)); }
            50% { opacity: 0.15; filter: none; }
        }
        .blinking .walker-svg.walk { animation: blink 1.2s infinite; }

        #time { font-size: 80px; font-weight: 800; margin: 10px 0; font-variant-numeric: tabular-nums; letter-spacing: -3px; }
        #state { font-size: 18px; margin-bottom: 30px; font-weight: 600; color: #888; }

        /* 제어 버튼 영역 */
        .sync-container { width: 100%; max-width: 340px; background: #151618; padding: 20px; border-radius: 25px; border: 1px solid #2a2a2a; margin-bottom: 20px; }
        .sync-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .sync-btn { 
            padding: 18px 10px; border: 1px solid #2a2a2a; border-radius: 16px; 
            background: #1e1f22; color: #bbb; font-size: 14px; font-weight: 700; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .sync-btn:active { transform: scale(0.97); background: #111; }
        .led-dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 5px currentColor; display: inline-block; }
        .led-red { background-color: var(--red); color: var(--red); }
        .led-green { background-color: var(--green); color: var(--green); }

        /* 관리자 패널 */
        .admin-toggle-btn { margin-top: 10px; background: none; border: none; color: #444; cursor: pointer; font-size: 12px; text-decoration: underline; }
        #admin-panel { display: none; width: 100%; max-width: 340px; background: #151618; padding: 25px; border-radius: 25px; border: 1px solid #333; margin-top: 15px; }
        .admin-input-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 14px; color: #888; font-weight: 600; }
        input { width: 90px; padding: 12px; border-radius: 10px; border: 1px solid #333; background: #000; color: #fff; text-align: center; font-weight: 700; font-size: 16px; }
        .save-btn { width: 100%; padding: 15px; background: var(--accent); border: none; color: #fff; border-radius: 12px; cursor: pointer; font-weight: 800; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="top-bar">
        <span class="date-display" id="date-el">--.--.--</span>
        <span class="time-display" id="time-el">--:--:--</span>
    </div>

    <div class="version-selector">
        <button class="version-btn" id="btn-v1" onclick="switchVersion('v1')">ver 1</button>
        <button class="version-btn" id="btn-v2" onclick="switchVersion('v2')">ver 2</button>
        <button class="version-btn" id="btn-v3" onclick="switchVersion('v3')">ver 3</button>
    </div>

    <div class="pedestrian-signal" id="signal-box">
        <div class="lamp-section" id="red-section">
            <svg class="walker-svg stop" viewBox="0 0 24 24">
                <path d="M12,2c1.1,0,2,0.9,2,2s-0.9,2-2,2s-2-0.9-2-2S10.9,2,12,2z M15,7H9C8.4,7,8,7.4,8,8v6c0,0.6,0.4,1,1,1h1v7h4v-7h1 c0.6,0,1-0.4,1-1V8C16,7.4,15.6,7,15,7z"/>
            </svg>
        </div>
        <div class="lamp-section" id="green-section">
            <svg class="walker-svg walk" viewBox="0 0 24 24">
                <path d="M13.5,5.5c1.1,0,2-0.9,2-2s-0.9-2-2-2s-2,0.9-2,2S12.4,5.5,13.5,5.5z M9.8,8.9L7,23h2.1l1.8-8l2.1,2v6h2v-7.5l-2.1-2l0.6-3C14.8,12,16.8,13,19,13v-2c-1.9,0-3.5-1-4.3-2.4l-1-1.6c-0.4-0.6-1-1-1.7-1c-0.3,0-0.5,0.1-0.8,0.2L8,8.3V13h2V9.6L9.8,8.9z"/>
            </svg>
        </div>
    </div>

    <div id="time">--</div>
    <div id="state">SYNCING...</div>

    <div class="sync-container">
        <div class="sync-grid">
            <button class="sync-btn" onclick="syncSignal(0)"><div class="led-dot led-red"></div><span>R1</span></button>
            <button class="sync-btn" onclick="syncSignal(1)"><div class="led-dot led-green"></div><span>G1</span></button>
            <button class="sync-btn" onclick="syncSignal(2)"><div class="led-dot led-red"></div><span>R2</span></button>
            <button class="sync-btn" onclick="syncSignal(3)"><div class="led-dot led-green"></div><span>G2</span></button>
        </div>
    </div>

    <button class="admin-toggle-btn" onclick="toggleAdmin()">SETTINGS</button>

    <div id="admin-panel">
        <h3 style="margin:0 0 15px 0; font-size:14px; color:var(--accent);" id="admin-title">V1 편집 중</h3>
        <div class="admin-input-group"><span>R1 (s)</span><input type="number" step="0.1" id="in-r1"></div>
        <div class="admin-input-group"><span>G1 (s)</span><input type="number" step="0.1" id="in-g1"></div>
        <div class="admin-input-group"><span>R2 (s)</span><input type="number" step="0.1" id="in-r2"></div>
        <div class="admin-input-group"><span>G2 (s)</span><input type="number" step="0.1" id="in-g2"></div>
        <button class="save-btn" onclick="savePattern()">이 버전 저장하기</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxwM-IBryLUHgCkOCFphd2GVhqILAINAk",
        authDomain: "signal-902a9.firebaseapp.com",
        databaseURL: "https://signal-902a9-default-rtdb.firebaseio.com",
        projectId: "signal-902a9",
        storageBucket: "signal-902a9.firebasestorage.app",
        messagingSenderId: "1040774154277",
        appId: "1:1040774154277:web:21c0ca2b2b2e9f6dca17cc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // 기본 패턴 (Firebase에 데이터가 없을 경우 대비)
    let DEFAULT_PATTERN = [{state:"RED",duration:110},{state:"GREEN",duration:26.5},{state:"RED",duration:35.5},{state:"GREEN",duration:26.5}];
    let currentPattern = [...DEFAULT_PATTERN];
    let currentVer = 'v1';
    let startTime = null;

    // 현재 활성화된 버전 및 전체 데이터 감시
    onValue(ref(db, "signal"), snap => {
        if (snap.exists()) {
            const data = snap.val();
            currentVer = data.currentVersion || 'v1';
            startTime = data.start;
            
            // 패턴 데이터 로드 (없으면 기본값 사용)
            const patterns = data.patterns || {};
            currentPattern = patterns[currentVer] || DEFAULT_PATTERN;

            // UI 업데이트
            updateVersionUI(currentVer);
            fillAdminInputs(currentPattern);
        }
    });

    window.switchVersion = (ver) => {
        set(ref(db, "signal/currentVersion"), ver);
    };

    function updateVersionUI(ver) {
        document.querySelectorAll('.version-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${ver}`).classList.add('active');
        document.getElementById('admin-title').innerText = `${ver.toUpperCase()} 편집 중`;
    }

    function fillAdminInputs(pattern) {
        document.getElementById('in-r1').value = pattern[0].duration;
        document.getElementById('in-g1').value = pattern[1].duration;
        document.getElementById('in-r2').value = pattern[2].duration;
        document.getElementById('in-g2').value = pattern[3].duration;
    }

    window.syncSignal = (index) => {
        let offset = 0;
        for(let i=0; i<index; i++) offset += Number(currentPattern[i].duration);
        set(ref(db, "signal/start"), (Date.now()/1000) - offset);
    };

    window.toggleAdmin = () => {
        const panel = document.getElementById('admin-panel');
        if(panel.style.display==='block') { panel.style.display='none'; return; }
        if(prompt("관리자 비밀번호")==="1234") panel.style.display='block';
    };

    window.savePattern = () => {
        const newPattern = [
            {state:"RED",duration:parseFloat(document.getElementById('in-r1').value)},
            {state:"GREEN",duration:parseFloat(document.getElementById('in-g1').value)},
            {state:"RED",duration:parseFloat(document.getElementById('in-r2').value)},
            {state:"GREEN",duration:parseFloat(document.getElementById('in-g2').value)}
        ];
        set(ref(db, `signal/patterns/${currentVer}`), newPattern).then(() => { 
            alert(`${currentVer.toUpperCase()} 저장 완료`); 
        });
    };

    function update() {
        const now = new Date();
        document.getElementById('date-el').innerText = `${now.getFullYear().toString().slice(-2)}.${(now.getMonth()+1).toString().padStart(2,'0')}.${now.getDate().toString().padStart(2,'0')}`;
        document.getElementById('time-el').innerText = now.toTimeString().split(' ')[0];

        if (startTime && currentPattern) {
            const currentTime = Date.now() / 1000;
            const TOTAL = currentPattern.reduce((sum, p) => sum + Number(p.duration), 0);
            let cycle = (currentTime - startTime) % TOTAL;
            let acc = 0;

            for (let step of currentPattern) {
                if (cycle < acc + step.duration) {
                    const rem = Math.ceil(acc + step.duration - cycle);
                    const isRed = (step.state === "RED");
                    const signalBox = document.getElementById('signal-box');
                    
                    signalBox.className = isRed ? "pedestrian-signal red-active" : "pedestrian-signal green-active";
                    
                    if(!isRed && rem <= 15) signalBox.classList.add('blinking');
                    else signalBox.classList.remove('blinking');

                    const sEl = document.getElementById('state');
                    const tEl = document.getElementById('time');
                    sEl.innerText = isRed ? "STOP" : "GO";
                    sEl.style.color = isRed ? "var(--red)" : "var(--green)";
                    tEl.innerText = rem;
                    tEl.style.color = isRed ? "var(--red)" : "var(--green)";
                    break;
                }
                acc += Number(step.duration);
            }
        }
        requestAnimationFrame(update);
    }
    update();
</script>
</body>
</html>

