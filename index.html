<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ìš°ë¦¬ì§‘ ì‹ í˜¸ë“±</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { text-align:center; font-family:Arial; margin-top:20px; }
.clock { font-size:22px; margin-bottom:20px; }
input { width:60px; font-size:16px; text-align:center; }
button { font-size:14px; margin:5px; padding:5px 10px; }
.state { font-size:50px; margin-top:20px; }
.count { font-size:80px; }
.next { font-size:28px; color:gray; }
.pattern-row { margin:5px; }
</style>
</head>

<body>

<div class="clock" id="clock"></div>

<h3>ğŸš¦ ì‹ í˜¸ íŒ¨í„´ ì„¤ì •</h3>

<div id="patternEditor"></div>

<button onclick="addStep()">+ ë‹¨ê³„ ì¶”ê°€</button>
<button onclick="savePattern()">ğŸ’¾ ì €ì¥</button>

<div>
<button onclick="setGreenNow()">ğŸŸ¢ ì§€ê¸ˆ ì´ˆë¡ ì‹œì‘</button>
<button onclick="setRedNow()">ğŸ”´ ì§€ê¸ˆ ë¹¨ê°• ì‹œì‘</button>
</div>

<div class="state" id="state"></div>
<div class="count" id="time"></div>
<div class="next" id="nextChange"></div>

<script>

// ğŸ”µ ê¸°ë³¸ íŒ¨í„´
let PATTERN = localStorage.getItem("pattern")
    ? JSON.parse(localStorage.getItem("pattern"))
    : [
        { state: "RED", duration: 60 },
        { state: "GREEN", duration: 30 },
        { state: "RED", duration: 20 },
        { state: "GREEN", duration: 30 }
    ];

let START_TIME = localStorage.getItem("startTime")
    ? parseFloat(localStorage.getItem("startTime"))
    : Date.now()/1000;

let START_STATE = localStorage.getItem("startState")
    ? localStorage.getItem("startState")
    : "GREEN";

// íŒ¨í„´ UI ìƒì„±
function renderEditor() {
    const container = document.getElementById("patternEditor");
    container.innerHTML = "";

    PATTERN.forEach((step, index) => {
        container.innerHTML += `
            <div class="pattern-row">
                <select id="state-${index}">
                    <option value="RED" ${step.state==="RED"?"selected":""}>ğŸ”´ ë¹¨ê°•</option>
                    <option value="GREEN" ${step.state==="GREEN"?"selected":""}>ğŸŸ¢ ì´ˆë¡</option>
                </select>
                <input type="number" id="duration-${index}" value="${step.duration}">
                ì´ˆ
                <button onclick="removeStep(${index})">âŒ</button>
            </div>
        `;
    });
}

// ë‹¨ê³„ ì¶”ê°€
function addStep() {
    PATTERN.push({ state: "RED", duration: 30 });
    renderEditor();
}

// ë‹¨ê³„ ì‚­ì œ
function removeStep(index) {
    PATTERN.splice(index, 1);
    renderEditor();
}

// íŒ¨í„´ ì €ì¥
function savePattern() {
    PATTERN = PATTERN.map((_, index) => ({
        state: document.getElementById(`state-${index}`).value,
        duration: parseInt(document.getElementById(`duration-${index}`).value)
    }));

    localStorage.setItem("pattern", JSON.stringify(PATTERN));
}

// ë™ê¸°í™” ë²„íŠ¼
function setGreenNow() {
    START_TIME = Date.now()/1000;
    START_STATE = "GREEN";
    localStorage.setItem("startTime", START_TIME);
    localStorage.setItem("startState", START_STATE);
}

function setRedNow() {
    START_TIME = Date.now()/1000;
    START_STATE = "RED";
    localStorage.setItem("startTime", START_TIME);
    localStorage.setItem("startState", START_STATE);
}

// ì„œìš¸ ì‹œê³„
function updateClock() {
    const now = new Date();
    const seoulTime = now.toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false
    });

    document.getElementById("clock").innerText =
        "í˜„ì¬ ì‹œê°: " + seoulTime;
}

// ì‹ í˜¸ ê³„ì‚°
function updateSignal() {

    const now = Date.now()/1000;
    const TOTAL = PATTERN.reduce((sum, p) => sum + p.duration, 0);

    let elapsed = now - START_TIME;
    let cycle = elapsed % TOTAL;

    // ì‹œì‘ ìƒíƒœ ë³´ì •
    if (START_STATE === "RED") {
        const firstGreenIndex = PATTERN.findIndex(p => p.state === "GREEN");
        if (firstGreenIndex !== -1) {
            const offset = PATTERN
                .slice(0, firstGreenIndex)
                .reduce((sum, p) => sum + p.duration, 0);
            cycle = (cycle + offset) % TOTAL;
        }
    }

    let accumulated = 0;

    for (let step of PATTERN) {

        if (cycle < accumulated + step.duration) {

            const remaining = Math.floor(accumulated + step.duration - cycle);

            if (step.state === "GREEN") {
                document.getElementById("state").innerText = "ğŸŸ¢ ì§€ê¸ˆ ì´ˆë¡ë¶ˆì…ë‹ˆë‹¤";
                document.getElementById("nextChange").innerText =
                    "ğŸ”´ ë¹¨ê°„ë¶ˆê¹Œì§€ " + remaining + "ì´ˆ";
            } else {
                document.getElementById("state").innerText = "ğŸ”´ ì§€ê¸ˆ ë¹¨ê°„ë¶ˆì…ë‹ˆë‹¤";
                document.getElementById("nextChange").innerText =
                    "ğŸŸ¢ ì´ˆë¡ë¶ˆê¹Œì§€ " + remaining + "ì´ˆ";
            }

            document.getElementById("time").innerText = remaining + "ì´ˆ";
            break;
        }

        accumulated += step.duration;
    }
}

function updateAll() {
    updateClock();
    updateSignal();
}

renderEditor();
setInterval(updateAll, 1000);
updateAll();

</script>

</body>
</html>
